{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Functions for the chat interface\n *\n * @module     block_exaaichat\n * @copyright  2025 GTN Solutions https://gtn-solutions.com\n * @copyright  based on work by Limekiller https://github.com/Limekiller/moodle-block_openai_chat\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable @babel/semi, no-undef */\nvar questionString = 'Ask a question...'\nvar errorString = 'An error occurred! Please try again later.'\n\nvar chatData;\n\nexport const init = (data) => {\n  const blockId = data['blockId']\n  const api_type = data['api_type']\n  const persistConvo = data['persistConvo']\n\n  // Initialize local data storage if necessary\n  // If a thread ID exists for this block, make an API request to get existing messages\n  if (api_type === 'assistant') {\n    chatData = localStorage.getItem(\"block_exaaichat_data\")\n    if (chatData) {\n      chatData = JSON.parse(chatData)\n      if (chatData[blockId] && chatData[blockId]['threadId'] && persistConvo === \"1\") {\n        fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/thread.php?thread_id=${chatData[blockId]['threadId']}`)\n          .then(response => response.json())\n          .then(data => {\n            for (let message of data) {\n              addToChatLog(message.role === 'user' ? 'user' : 'bot', message.message, blockId)\n            }\n          })\n          // Some sort of error in the API call. Probably the thread no longer exists, so lets reset it\n          .catch(() => {\n            chatData[blockId] = {}\n            localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n          })\n        // The block ID doesn't exist in the chat data object, so let's create it\n      } else {\n        chatData[blockId] = {}\n      }\n      // We don't even have a chat data object, so we'll create one\n    } else {\n      chatData = {[blockId]: {}}\n    }\n    localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n  }\n\n  if (api_type === 'responses') {\n    chatData = localStorage.getItem(\"block_exaaichat_data\")\n    if (chatData) {\n      chatData = JSON.parse(chatData)\n      if (chatData[blockId] && chatData[blockId]['threadId'] && persistConvo === \"1\") {\n        // fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/thread.php?thread_id=${chatData[blockId]['threadId']}`)\n        //   .then(response => response.json())\n        //   .then(data => {\n        //     for (let message of data) {\n        //       addToChatLog(message.role === 'user' ? 'user' : 'bot', message.message, blockId)\n        //     }\n        //   })\n        //   // Some sort of error in the API call. Probably the thread no longer exists, so lets reset it\n        //   .catch(error => {\n        //     chatData[blockId] = {}\n        //     localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n        //   })\n        // The block ID doesn't exist in the chat data object, so let's create it\n        chatData[blockId] = {}\n      } else {\n        chatData[blockId] = {}\n      }\n      // We don't even have a chat data object, so we'll create one\n    } else {\n      chatData = {[blockId]: {}}\n    }\n    localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n  }\n\n  // Prevent sidebar from closing when osk pops up (hack for MDL-77957)\n  window.addEventListener('resize', event => {\n    event.stopImmediatePropagation();\n  }, true);\n\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).addEventListener('keydown', e => {\n    if (e.which === 13 && e.target.value !== \"\") {\n      e.preventDefault();\n      addToChatLog('user', e.target.value, blockId)\n      createCompletion(e.target.value, blockId, api_type)\n      e.target.value = ''\n    }\n  })\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #go`).addEventListener('click', () => {\n    const input = document.querySelector('#openai_input')\n    if (input.value !== \"\") {\n      addToChatLog('user', input.value, blockId)\n      createCompletion(input.value, blockId, api_type)\n      input.value = ''\n    }\n  })\n\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #refresh`).addEventListener('click', () => {\n    clearHistory(blockId)\n  })\n\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #popout`).addEventListener('click', () => {\n    if (document.querySelector('.drawer.drawer-right')) {\n      document.querySelector('.drawer.drawer-right').style.zIndex = '1041'\n    }\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}']`).classList.toggle('expanded')\n  })\n\n  require(['core/str'], function (str) {\n    var strings = [\n      {\n        key: 'askaquestion',\n        component: 'block_exaaichat'\n      },\n      {\n        key: 'erroroccurred',\n        component: 'block_exaaichat'\n      },\n    ];\n    str.get_strings(strings).then((results) => {\n      questionString = results[0];\n      errorString = results[1];\n    });\n  });\n}\n\n/**\n * Add a message to the chat UI\n * @param {string} type Which side of the UI the message should be on. Can be \"user\" or \"bot\"\n * @param {string} message The text of the message to add\n * @param {int} blockId The ID of the block to manipulate\n */\nconst addToChatLog = (type, message, blockId) => {\n  let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #exaaichat_log`)\n\n  const messageElem = document.createElement('div')\n  messageElem.classList.add('openai_message')\n  for (let className of type.split(' ')) {\n    messageElem.classList.add(className)\n  }\n\n  const messageText = document.createElement('span')\n  messageText.innerHTML = message\n  messageElem.append(messageText)\n\n  messageContainer.append(messageElem)\n  if (messageText.offsetWidth) {\n    messageElem.style.width = (messageText.offsetWidth + 40) + \"px\"\n  }\n  messageContainer.scrollTop = messageContainer.scrollHeight\n  messageContainer.closest('.block_exaaichat > div').scrollTop = messageContainer.scrollHeight\n}\n\n/**\n * Clears the thread ID from local storage and removes the messages from the UI in order to refresh the chat\n * @param {int} blockId The ID of the block to manipulate\n */\nconst clearHistory = (blockId) => {\n  chatData = localStorage.getItem(\"block_exaaichat_data\")\n  if (chatData) {\n    chatData = JSON.parse(chatData)\n    if (chatData[blockId]) {\n      chatData[blockId] = {}\n      localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n    }\n  }\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #exaaichat_log`).innerHTML = \"\"\n}\n\n/**\n * Makes an API request to get a completion from GPT-3, and adds it to the chat log\n * @param {string} message The text to get a completion for\n * @param {int} blockId The ID of the block this message is being sent from -- used to override settings if necessary\n * @param {string} api_type \"assistant\" | \"chat\" The type of API to use\n */\nconst createCompletion = (message, blockId, api_type) => {\n  let threadId = null\n  let chatData\n\n  // If the type is assistant, attempt to fetch a thread ID\n  if (api_type === 'assistant' || api_type === 'responses') {\n    chatData = localStorage.getItem(\"block_exaaichat_data\")\n    if (chatData) {\n      chatData = JSON.parse(chatData)\n      if (chatData[blockId]) {\n        threadId = chatData[blockId]['threadId'] || null\n      }\n    } else {\n      // create the chat data item if necessary\n      chatData = {[blockId]: {}}\n    }\n  }\n\n  const history = buildTranscript(blockId)\n\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #control_bar`).classList.add('disabled')\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).classList.remove('error')\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).placeholder = questionString\n  document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).blur()\n  addToChatLog('bot loading', '...', blockId);\n\n  fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/completion.php?sesskey=${M.cfg.sesskey}`, {\n    method: 'POST',\n    body: JSON.stringify({\n      message: message,\n      history: history,\n      blockId: blockId,\n      threadId: threadId\n    })\n  })\n    .then(response => {\n      let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #exaaichat_log`)\n      messageContainer.removeChild(messageContainer.lastElementChild)\n      document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #control_bar`).classList.remove('disabled')\n\n      if (!response.ok) {\n        throw Error(response.statusText)\n      } else {\n        return response.json()\n      }\n    })\n    .then(data => {\n      if (data.error) {\n        const error = data.error;\n        logError(error);\n        addToChatLog('error', error, blockId)\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).classList.add('error')\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).placeholder = errorString\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).focus()\n        return;\n      }\n\n      try {\n        addToChatLog('bot', data.message, blockId)\n        if (data.thread_id) {\n          chatData[blockId]['threadId'] = data.thread_id;\n          localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(chatData));\n        }\n      } catch (error) {\n        logError(error);\n        addToChatLog('error', data.error.message, blockId)\n      }\n      document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).focus()\n    })\n    .catch(error => {\n      logError(error);\n      document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).classList.add('error')\n      document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).placeholder = errorString\n      document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] #openai_input`).focus()\n    })\n}\n\n/**\n * Log an error to the console and potentially to an external service in the future\n * @param {Error} error The error object to log\n */\nfunction logError(error) {\n  /* eslint-disable no-console */\n  console.error(error);\n}\n\n/**\n * Using the existing messages in the chat history, create a string that can be used to aid completion\n * @param {int} blockId The block from which to build the history\n * @return {JSONObject} A transcript of the conversation up to this point\n */\nconst buildTranscript = (blockId) => {\n  let transcript = []\n  document.querySelectorAll(`.block_exaaichat[data-instance-id='${blockId}'] .openai_message`).forEach((message, index) => {\n    if (index === document.querySelectorAll(`.block_exaaichat[data-instance-id='${blockId}'] .openai_message`).length - 1) {\n      return\n    }\n\n    let user = userName\n    if (message.classList.contains('bot')) {\n      user = assistantName\n    }\n    transcript.push({\"user\": user, \"message\": message.innerText})\n  })\n\n  return transcript\n}\n"],"names":["chatData","questionString","errorString","data","blockId","api_type","persistConvo","localStorage","getItem","JSON","parse","fetch","M","cfg","wwwroot","then","response","json","message","addToChatLog","role","catch","setItem","stringify","window","addEventListener","event","stopImmediatePropagation","document","querySelector","e","which","target","value","preventDefault","createCompletion","input","clearHistory","style","zIndex","classList","toggle","require","str","get_strings","key","component","results","type","messageContainer","messageElem","createElement","add","className","split","messageText","innerHTML","append","offsetWidth","width","scrollTop","scrollHeight","closest","threadId","history","buildTranscript","remove","placeholder","blur","sesskey","method","body","removeChild","lastElementChild","ok","Error","statusText","error","logError","focus","thread_id","console","transcript","querySelectorAll","forEach","index","length","user","userName","contains","assistantName","push","innerText"],"mappings":"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"}