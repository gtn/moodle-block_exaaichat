{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Functions for the chat interface\n *\n * @module     block_exaaichat\n * @copyright  2025 GTN Solutions https://gtn-solutions.com\n * @copyright  based on work by Limekiller https://github.com/Limekiller/moodle-block_openai_chat\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable @babel/semi, no-undef */\n\nimport {getStrings} from 'core/str';\nimport LocalStorage from 'core/localstorage';\n// import config from 'core/config';\nimport $ from 'jquery';\n\n/**\n * Initializes the chat interface\n * @param {object} data\n */\nexport async function init(data) {\n  const blockId = data['blockId'];\n  const api_type = data['api_type'];\n  const persistConvo = data['persistConvo'];\n  const userName = data['userName'];\n  const assistantName = data['assistantName'];\n  const showlabels = data['showlabels'];\n\n  const [questionString, errorString] = await getStrings([{\n    key: 'askaquestion', component: 'block_exaaichat'\n  }, {\n    key: 'erroroccurred', component: 'block_exaaichat'\n  }]);\n\n  // OLD: if javascript caching is turned of, then jsrev=-1 and then the moodle localstorage won't work (will not save anything)\n  // update: always use own localStorage logic, so the storage events can be used to sync between tabs\n  const useMoodleLocalStorage = false; // config.jsrev > 0;\n\n  const $form = $(`.block_exaaichat[data-instance-id='${blockId}']`);\n  const $input = $form.find('.exaaichat_input');\n\n  let historyTimestamp = 0;\n\n  /**\n   * Add a message to the chat UI\n   * @param {string} type Which side of the UI the message should be on. Can be \"user\" or \"assistant\"\n   * @param {string} message The text of the message to add\n   * @param {int} blockId The ID of the block to manipulate\n   */\n  function addToChatLog(type, message, blockId) {\n    let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_log`)\n    messageContainer.classList.remove('hidden');\n\n    const messageElem = document.createElement('div')\n    messageElem.classList.add('chat_message')\n    for (let className of type.split(' ')) {\n      messageElem.classList.add(className)\n    }\n\n    let label = '';\n    if (showlabels) {\n      if (type == 'user') {\n        label = userName;\n      } else if (type == 'assistant') {\n        label = assistantName;\n      }\n    }\n    if (label) {\n      const labelElement = document.createElement('div');\n      labelElement.classList.add('chat_message_label');\n      labelElement.innerHTML = label;\n      messageElem.append(labelElement);\n    }\n\n    const messageText = document.createElement('div')\n    messageText.classList.add('chat_message_content')\n    messageText.innerHTML = message\n    messageElem.append(messageText)\n\n    messageContainer.append(messageElem);\n    // if (messageText.offsetWidth) {\n    //   messageElem.style.width = (messageText.offsetWidth + 40) + \"px\"\n    // }\n    messageContainer.scrollTop = messageContainer.scrollHeight\n    messageContainer.closest('.block_exaaichat > div').scrollTop = messageContainer.scrollHeight\n  }\n\n  /**\n   * Get chat data\n   * @returns {object} The chat data object\n   */\n  function getAllChatsData() {\n    let chatData = useMoodleLocalStorage ? LocalStorage.get(\"block_exaaichat_data\") : localStorage.getItem(\"block_exaaichat_data\");\n    if (chatData) {\n      chatData = JSON.parse(chatData);\n    }\n\n    return chatData || {};\n  }\n\n  /**\n   * set chat data\n   * @param {object} data\n   */\n  function setAllChatsData(data) {\n    if (useMoodleLocalStorage) {\n      LocalStorage.set(\"block_exaaichat_data\", JSON.stringify(data));\n    } else {\n      localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(data));\n    }\n  }\n\n  /**\n   * Get chat data for a specific block\n   * @returns {object}\n   */\n  function getBlockChatData() {\n    let chatData = getAllChatsData();\n    return chatData[blockId] || {};\n  }\n\n  /**\n   * Set chat data for a specific block\n   * @param {object} data\n   */\n  function setBlockChatData(data) {\n    let chatData = getAllChatsData();\n    if (chatData[blockId]) {\n      data = {...chatData[blockId], ...data};\n    }\n    chatData[blockId] = data;\n    setAllChatsData(chatData);\n  }\n\n  /**\n   * clear the data for a specific block\n   */\n  /*\n  function clearBlockChatData() {\n    let chatData = getAllChatsData();\n    delete chatData[blockId];\n    setAllChatsData(chatData);\n  }\n  */\n\n  /**\n   * Add messages to the history for this block\n   * @param {array} messages\n   */\n  function addHistory(messages) {\n    let history = getBlockChatData().history || [];\n    history = [...history, ...messages];\n    historyTimestamp = Date.now();\n    setBlockChatData({history, historyTimestamp});\n  }\n\n  /**\n   * Clears the thread ID from local storage and removes the messages from the UI in order to refresh the chat\n   */\n  function clearHistory() {\n    $form.find('.exaaichat_log')\n      .html('')\n      .addClass('hidden');\n  }\n\n  /**\n   * Makes an API request to get a completion from GPT-3, and adds it to the chat log\n   * @param {string} message The text to get a completion for\n   * @param {int} blockId The ID of the block this message is being sent from -- used to override settings if necessary\n   * @param {string} api_type \"assistant\" | \"chat\" The type of API to use\n   */\n  const createCompletion = (message, blockId, api_type) => {\n    let threadId = null\n\n    // If the type is assistant, attempt to fetch a thread ID\n    if (api_type === 'assistant' || api_type === 'responses') {\n      let chatData = getBlockChatData();\n      threadId = chatData['threadId'] || null\n    }\n\n    let history = [];\n    if (api_type == 'assistant' || api_type === 'responses') {\n      // they are stateful and don't need a history\n    } else {\n      history = getBlockChatData().history || [];\n    }\n    let providerId = $form.find('select[name=\"ai_provider\"]').val();\n\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_control_bar`).classList.add('disabled')\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).classList.remove('error')\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).placeholder = questionString\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).blur()\n    addToChatLog('assistant loading', '...', blockId);\n\n    fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/completion.php?sesskey=${M.cfg.sesskey}`, {\n      method: 'POST', body: JSON.stringify({\n        message, history, blockId, providerId, threadId\n      })\n    })\n      .then(response => {\n        let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_log`)\n        messageContainer.removeChild(messageContainer.lastElementChild)\n        $form.find('.exaaichat_control_bar').removeClass('disabled');\n\n        if (!response.ok) {\n          throw Error(response.statusText)\n        } else {\n          return response.json()\n        }\n      })\n      .then(data => {\n        if (data.error) {\n          const error = data.error;\n          logError(error);\n          addToChatLog('error', error, blockId)\n\n          addHistory([\n            {\"type\": \"user\", \"message\": message},\n            {\"type\": \"error\", \"message\": error},\n          ]);\n\n          document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).classList.add('error')\n          document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).placeholder = errorString\n          $input.focus();\n          return;\n        }\n\n        try {\n          addToChatLog('assistant', data.message, blockId)\n          if (data.thread_id) {\n            setBlockChatData({threadId: data.thread_id});\n          }\n\n          addHistory([\n            {\"type\": \"user\", \"message\": message},\n            {\"type\": \"assistant\", \"message\": data.message},\n          ]);\n        } catch (error) {\n          logError(error);\n          addToChatLog('error', data.error.message, blockId)\n          addHistory([\n            {\"type\": \"user\", \"message\": message},\n            {\"type\": \"error\", \"message\": data.error.message},\n          ]);\n        }\n        $input.focus();\n      })\n      .catch(error => {\n        logError(error);\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).classList.add('error')\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).placeholder = errorString\n        $input.focus();\n      })\n  }\n\n  /**\n   * Reload chat history from local storage\n   */\n  function reloadChatHistory() {\n    let chatData = getBlockChatData();\n    historyTimestamp = chatData.historyTimestamp || 0;\n\n    clearHistory();\n    let history = chatData.history || [];\n    for (let message of history) {\n      addToChatLog(message.type, message.message, blockId)\n    }\n  }\n\n  /**\n   * Log an error to the console and potentially to an external service in the future\n   * @param {Error} error The error object to log\n   */\n  function logError(error) {\n    /* eslint-disable no-console */\n    console.error(error);\n  }\n\n  // Initialize local data storage if necessary\n  // If a thread ID exists for this block, make an API request to get existing messages\n  /*\n  if (api_type === 'assistant') {\n    let chatData = getBlockChatData();\n    if (chatData['threadId'] && persistConvo) {\n      fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/thread.php?thread_id=${chatData['threadId']}`)\n        .then(response => response.json())\n        .then(data => {\n          for (let message of data) {\n            addToChatLog(message.role === 'user' ? 'user' : 'assistant', message.message, blockId)\n          }\n        })\n        // Some sort of error in the API call. Probably the thread no longer exists, so lets reset it\n        .catch(() => {\n          // clearBlockChatData();\n        })\n      // The block ID doesn't exist in the chat data object, so let's create it\n    }\n    // We don't even have a chat data object, so we'll create one\n  } else {\n  */\n\n  if (persistConvo) {\n    reloadChatHistory();\n  }\n  // }\n\n// Prevent sidebar from closing when osk pops up (hack for MDL-77957)\n  window.addEventListener('resize', event => {\n    event.stopImmediatePropagation();\n  }, true);\n\n  $form.find('.exaaichat_input').on('keydown', e => {\n    if (e.which === 13 && e.target.value !== \"\") {\n      e.preventDefault();\n      addToChatLog('user', e.target.value, blockId)\n      createCompletion(e.target.value, blockId, api_type)\n      e.target.value = ''\n    }\n  })\n  $form.find('.exaaichat_input_submit_btn').on('click', () => {\n    if ($input.val()) {\n      addToChatLog('user', $input.val(), blockId);\n      createCompletion($input.val(), blockId, api_type);\n      $input.val('');\n    } else {\n      $input.focus();\n    }\n  })\n\n  $form.find('.exaaichat_input_refresh_btn').on('click', () => {\n    setBlockChatData({history: [], historyTimestamp: Date.now()});\n    clearHistory();\n    $input.focus();\n  })\n\n  $form.find('.exaaichat_popout_btn, .exaaichat_btn_close').click(() => {\n    if (document.querySelector('.drawer.drawer-right')) {\n      document.querySelector('.drawer.drawer-right').style.zIndex = '1041';\n    }\n    $form.toggleClass('expanded');\n  });\n\n  // beim laden den letzten ai_provider setzen\n  const ai_provider = getBlockChatData().ai_provider;\n  if (ai_provider) {\n    $form.find('select[name=\"ai_provider\"]').val(ai_provider);\n  }\n  $form.find('select[name=\"ai_provider\"]').on('change', function () {\n    setBlockChatData({ai_provider: this.value});\n  });\n\n  if (!useMoodleLocalStorage) {\n    // handle changes from other windows/tabs\n    window.addEventListener(\"storage\", (event) => {\n      if (event.key !== \"block_exaaichat_data\") {\n        return;\n      }\n\n      const chatData = getBlockChatData();\n      $form.find('select[name=\"ai_provider\"]').val(chatData.ai_provider);\n\n      if (historyTimestamp != (chatData.historyTimestamp || 0)) {\n        reloadChatHistory();\n      }\n    });\n  }\n}\n"],"names":["data","blockId","api_type","persistConvo","userName","assistantName","showlabels","questionString","errorString","key","component","$form","$input","find","historyTimestamp","addToChatLog","type","message","messageContainer","document","querySelector","classList","remove","messageElem","createElement","add","className","split","label","labelElement","innerHTML","append","messageText","scrollTop","scrollHeight","closest","getAllChatsData","chatData","localStorage","getItem","JSON","parse","getBlockChatData","setBlockChatData","setItem","stringify","setAllChatsData","addHistory","messages","history","Date","now","clearHistory","html","addClass","createCompletion","threadId","providerId","val","placeholder","blur","fetch","M","cfg","wwwroot","sesskey","method","body","then","response","removeChild","lastElementChild","removeClass","ok","json","Error","statusText","error","logError","focus","thread_id","catch","reloadChatHistory","console","window","addEventListener","event","stopImmediatePropagation","on","e","which","target","value","preventDefault","click","style","zIndex","toggleClass","ai_provider","this"],"mappings":"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"}