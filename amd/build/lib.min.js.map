{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Functions for the chat interface\n *\n * @module     block_exaaichat\n * @copyright  2025 GTN Solutions https://gtn-solutions.com\n * @copyright  based on work by Limekiller https://github.com/Limekiller/moodle-block_openai_chat\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable @babel/semi, no-undef */\n\nimport {getStrings} from './helper';\nimport LocalStorage from 'core/localstorage';\n// import config from 'core/config';\nimport $ from 'jquery';\n\n/**\n * Initializes the chat interface\n * @param {object} data\n */\nexport async function init(data) {\n  const {\n    blockId,\n    api_type,\n    persistConvo,\n    userName,\n    assistantName,\n    showlabels,\n    allow_access_to_current_page,\n  } = data;\n\n  const [questionString, errorString] = await getStrings([{\n    key: 'askaquestion', component: 'block_exaaichat'\n  }, {\n    key: 'erroroccurred', component: 'block_exaaichat'\n  }]);\n\n  // OLD: if javascript caching is turned of, then jsrev=-1 and then the moodle localstorage won't work (will not save anything)\n  // update: always use own localStorage logic, so the storage events can be used to sync between tabs\n  const useMoodleLocalStorage = false; // config.jsrev > 0;\n\n  const $form = $(`.block_exaaichat[data-instance-id='${blockId}']`);\n  const $input = $form.find('.exaaichat_input');\n\n  let historyTimestamp = 0;\n\n  /**\n   * Add a message to the chat UI\n   * @param {string} type Which side of the UI the message should be on. Can be \"user\" or \"assistant\"\n   * @param {string} message The text of the message to add\n   * @param {int} blockId The ID of the block to manipulate\n   */\n  function addToChatLog(type, message, blockId) {\n    let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_log`)\n    messageContainer.classList.remove('hidden');\n\n    const messageElem = document.createElement('div')\n    messageElem.classList.add('chat_message')\n    for (let className of type.split(' ')) {\n      messageElem.classList.add(className)\n    }\n\n    let label = '';\n    if (showlabels) {\n      if (type == 'user') {\n        label = userName;\n      } else if (type == 'assistant') {\n        label = assistantName;\n      }\n    }\n    if (label) {\n      const labelElement = document.createElement('div');\n      labelElement.classList.add('chat_message_label');\n      labelElement.innerHTML = label;\n      messageElem.append(labelElement);\n    }\n\n    const messageText = document.createElement('div')\n    messageText.classList.add('chat_message_content')\n    messageText.innerHTML = message\n    messageElem.append(messageText)\n\n    messageContainer.append(messageElem);\n    // if (messageText.offsetWidth) {\n    //   messageElem.style.width = (messageText.offsetWidth + 40) + \"px\"\n    // }\n    messageContainer.scrollTop = messageContainer.scrollHeight\n    messageContainer.closest('.block_exaaichat > div').scrollTop = messageContainer.scrollHeight\n  }\n\n  /**\n   * Get chat data\n   * @returns {object} The chat data object\n   */\n  function getAllChatsData() {\n    let chatData = useMoodleLocalStorage ? LocalStorage.get(\"block_exaaichat_data\") : localStorage.getItem(\"block_exaaichat_data\");\n    if (chatData) {\n      chatData = JSON.parse(chatData);\n    }\n\n    return chatData || {};\n  }\n\n  /**\n   * set chat data\n   * @param {object} data\n   */\n  function setAllChatsData(data) {\n    if (useMoodleLocalStorage) {\n      LocalStorage.set(\"block_exaaichat_data\", JSON.stringify(data));\n    } else {\n      localStorage.setItem(\"block_exaaichat_data\", JSON.stringify(data));\n    }\n  }\n\n  /**\n   * Get chat data for a specific block\n   * @returns {object}\n   */\n  function getBlockChatData() {\n    let chatData = getAllChatsData();\n    return chatData[blockId] || {};\n  }\n\n  /**\n   * Set chat data for a specific block\n   * @param {object} data\n   */\n  function setBlockChatData(data) {\n    let chatData = getAllChatsData();\n    if (chatData[blockId]) {\n      data = {...chatData[blockId], ...data};\n    }\n    chatData[blockId] = data;\n    setAllChatsData(chatData);\n  }\n\n  /**\n   * clear the data for a specific block\n   */\n\n  /*\n  function clearBlockChatData() {\n    let chatData = getAllChatsData();\n    delete chatData[blockId];\n    setAllChatsData(chatData);\n  }\n  */\n\n  /**\n   * Add messages to the history for this block\n   * @param {array} messages\n   */\n  function addHistory(messages) {\n    let history = getBlockChatData().history || [];\n    history = [...history, ...messages];\n    historyTimestamp = Date.now();\n    setBlockChatData({history, historyTimestamp});\n  }\n\n  /**\n   * Clears the thread ID from local storage and removes the messages from the UI in order to refresh the chat\n   */\n  function clearHistory() {\n    $form.find('.exaaichat_log')\n      .html('')\n      .addClass('hidden');\n  }\n\n  /**\n   * Get the text content of the main region.\n   * @return {String} The text content.\n   */\n  function getPageContent() {\n    const mainRegion = document.querySelector('[role=\"main\"]');\n    if (!mainRegion) {\n      return \"\";\n    }\n\n    // Clone the main region so we don't touch the real DOM\n    const clone = mainRegion.cloneNode(true);\n\n    // Remove all unwanted blocks\n    clone.querySelectorAll('.block_exaaichat, #ai-features').forEach(el => el.remove());\n\n    // Return text without that block\n    return clone.innerText || clone.textContent;\n  }\n\n  /**\n   * Makes an API request to get a completion from GPT-3, and adds it to the chat log\n   * @param {string} message The text to get a completion for\n   * @param {int} blockId The ID of the block this message is being sent from -- used to override settings if necessary\n   * @param {string} api_type \"assistant\" | \"chat\" The type of API to use\n   */\n  const createCompletion = (message, blockId, api_type) => {\n    let threadId = null\n\n    // If the type is assistant, attempt to fetch a thread ID\n    if (api_type === 'assistant' || api_type === 'responses') {\n      let chatData = getBlockChatData();\n      threadId = chatData['threadId'] || null\n    }\n\n    let history = [];\n    if (api_type == 'assistant' || api_type === 'responses') {\n      // they are stateful and don't need a history\n    } else {\n      history = getBlockChatData().history || [];\n    }\n    let providerId = $form.find('select[name=\"ai_provider\"]').val();\n\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_control_bar`).classList.add('disabled')\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).classList.remove('error')\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).placeholder = questionString\n    document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).blur()\n    addToChatLog('assistant loading', '...', blockId);\n\n    fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/completion.php?sesskey=${M.cfg.sesskey}`, {\n      method: 'POST', body: JSON.stringify({\n        message, history, blockId, providerId, threadId,\n        pageContent: allow_access_to_current_page ? getPageContent() : null,\n      })\n    })\n      .then(async (response) => {\n        let messageContainer = document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_log`)\n        messageContainer.removeChild(messageContainer.lastElementChild)\n        $form.find('.exaaichat_control_bar').removeClass('disabled');\n\n        if (!response.ok) {\n          throw Error(response.statusText);\n        } else {\n          const responseText = await response.text();\n\n          try {\n            return JSON.parse(responseText);\n          } catch {\n            // Not JSON â†’ try HTML error parsing\n            const errorMessage = $(responseText).find('.errormessage').text()\n              // debuggingmessage is maybe the current element or a subelement\n              || $('<div>' + responseText + '</div>').find('.debuggingmessage').text()\n              || 'Unknown return value from server';\n\n            throw new Error(errorMessage);\n          }\n        }\n      })\n      .then(data => {\n        if (data.error) {\n          throw new Error(data.error);\n        }\n\n        addToChatLog('assistant', data.message, blockId)\n        if (data.thread_id) {\n          setBlockChatData({threadId: data.thread_id});\n        }\n\n        addHistory([\n          {\"type\": \"user\", \"message\": message},\n          {\"type\": \"assistant\", \"message\": data.message},\n        ]);\n\n        $input.focus();\n      })\n      .catch(error => {\n        logError(error);\n        addToChatLog('error', error.message, blockId)\n        addHistory([\n          {\"type\": \"user\", \"message\": message},\n          {\"type\": \"error\", \"message\": error.message},\n        ]);\n\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).classList.add('error')\n        document.querySelector(`.block_exaaichat[data-instance-id='${blockId}'] .exaaichat_input`).placeholder = errorString\n        $input.focus();\n      })\n  }\n\n  /**\n   * Reload chat history from local storage\n   */\n  function reloadChatHistory() {\n    let chatData = getBlockChatData();\n    historyTimestamp = chatData.historyTimestamp || 0;\n\n    clearHistory();\n    let history = chatData.history || [];\n    for (let message of history) {\n      addToChatLog(message.type, message.message, blockId)\n    }\n  }\n\n  /**\n   * Log an error to the console and potentially to an external service in the future\n   * @param {Error} error The error object to log\n   */\n  function logError(error) {\n    /* eslint-disable no-console */\n    console.error(error);\n  }\n\n  // Initialize local data storage if necessary\n  // If a thread ID exists for this block, make an API request to get existing messages\n  /*\n  if (api_type === 'assistant') {\n    let chatData = getBlockChatData();\n    if (chatData['threadId'] && persistConvo) {\n      fetch(`${M.cfg.wwwroot}/blocks/exaaichat/api/thread.php?thread_id=${chatData['threadId']}`)\n        .then(response => response.json())\n        .then(data => {\n          for (let message of data) {\n            addToChatLog(message.role === 'user' ? 'user' : 'assistant', message.message, blockId)\n          }\n        })\n        // Some sort of error in the API call. Probably the thread no longer exists, so lets reset it\n        .catch(() => {\n          // clearBlockChatData();\n        })\n      // The block ID doesn't exist in the chat data object, so let's create it\n    }\n    // We don't even have a chat data object, so we'll create one\n  } else {\n  */\n\n  if (persistConvo) {\n    reloadChatHistory();\n  }\n  // }\n\n// Prevent sidebar from closing when osk pops up (hack for MDL-77957)\n  window.addEventListener('resize', event => {\n    event.stopImmediatePropagation();\n  }, true);\n\n  $form.find('.exaaichat_input').on('keydown', e => {\n    if (e.which === 13 && e.target.value !== \"\") {\n      e.preventDefault();\n      addToChatLog('user', e.target.value, blockId)\n      createCompletion(e.target.value, blockId, api_type)\n      e.target.value = ''\n    }\n  })\n  $form.find('.exaaichat_input_submit_btn').on('click', () => {\n    if ($input.val()) {\n      addToChatLog('user', $input.val(), blockId);\n      createCompletion($input.val(), blockId, api_type);\n      $input.val('');\n    } else {\n      $input.focus();\n    }\n  })\n\n  $form.find('.exaaichat_input_refresh_btn').on('click', () => {\n    setBlockChatData({history: [], historyTimestamp: Date.now()});\n    clearHistory();\n    $input.focus();\n  })\n\n  $form.find('.exaaichat_popout_btn, .exaaichat_btn_close').click(() => {\n    if (document.querySelector('.drawer.drawer-right')) {\n      document.querySelector('.drawer.drawer-right').style.zIndex = '1041';\n    }\n    $form.toggleClass('expanded');\n  });\n\n  // beim laden den letzten ai_provider setzen\n  const ai_provider = getBlockChatData().ai_provider;\n  if (ai_provider) {\n    $form.find('select[name=\"ai_provider\"]').val(ai_provider);\n  }\n  $form.find('select[name=\"ai_provider\"]').on('change', function () {\n    setBlockChatData({ai_provider: this.value});\n  });\n\n  // enable inputs after page loaded\n  $form.find('.disabled').removeClass('disabled');\n\n  if (!useMoodleLocalStorage) {\n    // handle changes from other windows/tabs\n    window.addEventListener(\"storage\", (event) => {\n      if (event.key !== \"block_exaaichat_data\") {\n        return;\n      }\n\n      const chatData = getBlockChatData();\n      $form.find('select[name=\"ai_provider\"]').val(chatData.ai_provider);\n\n      if (historyTimestamp != (chatData.historyTimestamp || 0)) {\n        reloadChatHistory();\n      }\n    });\n  }\n}\n"],"names":["data","blockId","api_type","persistConvo","userName","assistantName","showlabels","allow_access_to_current_page","questionString","errorString","key","component","$form","$input","find","historyTimestamp","addToChatLog","type","message","messageContainer","document","querySelector","classList","remove","messageElem","createElement","add","className","split","label","labelElement","innerHTML","append","messageText","scrollTop","scrollHeight","closest","getAllChatsData","chatData","localStorage","getItem","JSON","parse","getBlockChatData","setBlockChatData","setItem","stringify","setAllChatsData","addHistory","messages","history","Date","now","clearHistory","html","addClass","getPageContent","mainRegion","clone","cloneNode","querySelectorAll","forEach","el","innerText","textContent","createCompletion","threadId","providerId","val","placeholder","blur","fetch","M","cfg","wwwroot","sesskey","method","body","pageContent","then","async","removeChild","lastElementChild","removeClass","response","ok","Error","statusText","responseText","text","errorMessage","error","thread_id","focus","catch","console","logError","reloadChatHistory","window","addEventListener","event","stopImmediatePropagation","on","e","which","target","value","preventDefault","click","style","zIndex","toggleClass","ai_provider","this"],"mappings":"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"}