define("block_exaaichat/lib",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;
/**
   * Functions for the chat interface
   *
   * @module     block_exaaichat
   * @copyright  2025 GTN Solutions https://gtn-solutions.com
   * @copyright  based on work by Limekiller https://github.com/Limekiller/moodle-block_openai_chat
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
var chatData,questionString="Ask a question...",errorString="An error occurred! Please try again later.";_exports.init=data=>{const blockId=data.blockId,api_type=data.api_type,persistConvo=data.persistConvo;"assistant"===api_type&&((chatData=localStorage.getItem("block_exaaichat_data"))?(chatData=JSON.parse(chatData))[blockId]&&chatData[blockId].threadId&&"1"===persistConvo?fetch("".concat(M.cfg.wwwroot,"/blocks/exaaichat/api/thread.php?thread_id=").concat(chatData[blockId].threadId)).then((response=>response.json())).then((data=>{for(let message of data)addToChatLog("user"===message.role?"user":"bot",message.message,blockId)})).catch((()=>{chatData[blockId]={},localStorage.setItem("block_exaaichat_data",JSON.stringify(chatData))})):chatData[blockId]={}:chatData={[blockId]:{}},localStorage.setItem("block_exaaichat_data",JSON.stringify(chatData))),"responses"===api_type&&((chatData=localStorage.getItem("block_exaaichat_data"))?((chatData=JSON.parse(chatData))[blockId]&&chatData[blockId].threadId,chatData[blockId]={}):chatData={[blockId]:{}},localStorage.setItem("block_exaaichat_data",JSON.stringify(chatData))),window.addEventListener("resize",(event=>{event.stopImmediatePropagation()}),!0),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).addEventListener("keyup",(e=>{13===e.which&&""!==e.target.value&&(addToChatLog("user",e.target.value,blockId),createCompletion(e.target.value,blockId,api_type),e.target.value="")})),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #go")).addEventListener("click",(()=>{const input=document.querySelector("#openai_input");""!==input.value&&(addToChatLog("user",input.value,blockId),createCompletion(input.value,blockId,api_type),input.value="")})),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #refresh")).addEventListener("click",(()=>{clearHistory(blockId)})),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #popout")).addEventListener("click",(()=>{document.querySelector(".drawer.drawer-right")&&(document.querySelector(".drawer.drawer-right").style.zIndex="1041"),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"']")).classList.toggle("expanded")})),require(["core/str"],(function(str){str.get_strings([{key:"askaquestion",component:"block_exaaichat"},{key:"erroroccurred",component:"block_exaaichat"}]).then((results=>{questionString=results[0],errorString=results[1]}))}))};const addToChatLog=(type,message,blockId)=>{let messageContainer=document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #exaaichat_log"));const messageElem=document.createElement("div");messageElem.classList.add("openai_message");for(let className of type.split(" "))messageElem.classList.add(className);const messageText=document.createElement("span");messageText.innerHTML=message,messageElem.append(messageText),messageContainer.append(messageElem),messageText.offsetWidth&&(messageElem.style.width=messageText.offsetWidth+40+"px"),messageContainer.scrollTop=messageContainer.scrollHeight,messageContainer.closest(".block_exaaichat > div").scrollTop=messageContainer.scrollHeight},clearHistory=blockId=>{(chatData=localStorage.getItem("block_exaaichat_data"))&&(chatData=JSON.parse(chatData))[blockId]&&(chatData[blockId]={},localStorage.setItem("block_exaaichat_data",JSON.stringify(chatData))),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #exaaichat_log")).innerHTML=""},createCompletion=(message,blockId,api_type)=>{let chatData,threadId=null;"assistant"!==api_type&&"responses"!==api_type||(chatData=localStorage.getItem("block_exaaichat_data"),chatData?(chatData=JSON.parse(chatData),chatData[blockId]&&(threadId=chatData[blockId].threadId||null)):chatData={[blockId]:{}});const history=buildTranscript(blockId);document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #control_bar")).classList.add("disabled"),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).classList.remove("error"),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).placeholder=questionString,document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).blur(),addToChatLog("bot loading","...",blockId),fetch("".concat(M.cfg.wwwroot,"/blocks/exaaichat/api/completion.php"),{method:"POST",body:JSON.stringify({message:message,history:history,blockId:blockId,threadId:threadId})}).then((response=>{let messageContainer=document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #exaaichat_log"));if(messageContainer.removeChild(messageContainer.lastElementChild),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #control_bar")).classList.remove("disabled"),response.ok)return response.json();throw Error(response.statusText)})).then((data=>{try{addToChatLog("bot",data.message,blockId),data.thread_id&&(chatData[blockId].threadId=data.thread_id,localStorage.setItem("block_exaaichat_data",JSON.stringify(chatData)))}catch(error){logError(error),addToChatLog("bot",data.error.message,blockId)}document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).focus()})).catch((error=>{logError(error),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).classList.add("error"),document.querySelector(".block_exaaichat[data-instance-id='".concat(blockId,"'] #openai_input")).placeholder=errorString}))};function logError(error){console.error(error)}const buildTranscript=blockId=>{let transcript=[];return document.querySelectorAll(".block_exaaichat[data-instance-id='".concat(blockId,"'] .openai_message")).forEach(((message,index)=>{if(index===document.querySelectorAll(".block_exaaichat[data-instance-id='".concat(blockId,"'] .openai_message")).length-1)return;let user=userName;message.classList.contains("bot")&&(user=assistantName),transcript.push({user:user,message:message.innerText})})),transcript}}));

//# sourceMappingURL=lib.min.js.map